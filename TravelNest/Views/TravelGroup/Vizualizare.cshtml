@model TravelNest.Models.TravelGroup
@using System.Text.Json
<script>
    window.selectedCities = @Html.Raw(JsonSerializer.Serialize(Model.Locatii.Select(l => l.Locatie)));
</script>
@{
    int nrZile = 0;
    if (Model.DataPlecare.HasValue && Model.DataIntoarcere.HasValue)
    {
        var st = Model.DataPlecare.Value.ToDateTime(TimeOnly.MinValue);
        var ed = Model.DataIntoarcere.Value.ToDateTime(TimeOnly.MinValue);
        nrZile = (ed - st).Days + 1;
        if (nrZile < 0) 
            nrZile = 0;
    }
}
@functions {
    public string IconitaFisier(string numeFisier)
    {
        if (string.IsNullOrEmpty(numeFisier)) return "fa-solid fa-file";

        string extensie = System.IO.Path.GetExtension(numeFisier).ToLower();

        return extensie switch
        {
            ".jpg" or ".jpeg" or ".png" => "fa-solid fa-file-image",
            ".pdf" => "fa-solid fa-file-pdf",
            ".doc" or ".docx" => "fa-solid fa-file-word",
            ".xls" or ".xlsx" => "fa-solid fa-file-excel",
            _ => "fa-solid fa-file"
        };
    }
}
<html>

    <head>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet" href="~/css/Profil.css">
        <link rel="stylesheet" href="~/css/vizualizareTG.css">
        <link rel="stylesheet" href="~/css/travelGr.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    </head>
    <body>
        <i id="menuBtn" class="fa-solid fa-bars"></i>
        <div class="sideMenu">
            <img id="logoMenu" src="~/images/logoMenu.png" />
            <div id="butonMeniu">
                <a asp-controller="Profil" asp-action="Index">
                    <p>Profile</p>
                </a>
            </div>
            <div id="butonMeniu">
                <a asp-controller="Notifications" asp-action="Index">
                    <p>Notifications</p>
                    <span id="punctRosu" style="display:none;">0</span>
                </a>
            </div>
            <div id="butonMeniu">
                <p>For You</p>
            </div>
            <div id="butonMeniu" class="AddPost2">
                <p>New Post</p>
            </div>
            <div id="butonMeniu">
                <a asp-controller="TravelGroup" asp-action="Index">
                    <p>New Travel Group</p>
                </a>
            </div>
            <div id="butonMeniu">
                <p>Search Destination</p>
            </div>
            <div id="butonMeniu">
                <p>Find Accommodation</p>
            </div>
            <div id="butonMeniu">
                <p>Travel Map</p>
            </div>
            <div class="butoaneJos">

                <div id="butonMeniu">
                    <a asp-controller="Settings" asp-action="Index">
                        <p>Settings</p>
                    </a>
                </div>
                <div id="butonMeniu" class="logoutBtn">
                    <a asp-area="Identity" asp-page="/Account/Logout">
                        <p>Logout</p>
                    </a>
                </div>
            </div>
        </div>
        <div id="detaliiTG">
        <header id="detaliiHero">
            <div id="bannerVizualizare" data-idGrup="@Model.Id">
                <img src="@(string.IsNullOrEmpty(Model.Thumbnail) ? "/images/default-trip.jpg" : Model.Thumbnail.Split(',')[0])" alt="Trip Banner" id="imgThumbnail">
                <input type="hidden" id="inputThumbnail" value="@Model.Thumbnail">

                <div class="hero-overlay">
                    <div class="hero-content">
                        <div class="hero-meta">
                            <span class="status-badge active-trip">ACTIVE TRIP</span>
                            <span class="trip-dates-hero">
                                <i class="fa-solid fa-calendar-days"></i>
                                @Model.DataPlecare?.ToString("MMM dd") — @Model.DataIntoarcere?.ToString("MMM dd, yyyy")
                            </span>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Nume))
                        {
                            <h1 id="titliTG">@Model.Nume</h1>
                        }

                        @if (!string.IsNullOrEmpty(Model.Descriere))
                        {
                            <p id="descriereTG">@Model.Descriere</p>
                        }

                        <div id="detaliiButoane">
                            <button id="EditGrup" onclick="afiseazaEdit(true)">
                                <i class="fa-solid fa-pen-to-square"></i> Edit Group Details
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modEditare" id="continutEditareBanner" style="display: none;">
                    <div id="editareBox">
                        <div id="campuriEdit">
                            <input type="text" id="editNume" value="@Model.Nume" placeholder="Trip Name...">
                            <textarea id="editDescriere" placeholder="Description...">@Model.Descriere</textarea>
                        </div>

                        <div id="butoaneEditare">
                            <div id="butoaneThumbnail">
                                <input type="file" id="incarcaImagine" style="display: none;" accept="image/*" onchange="previewImagine(this)">
                                <button id="butonUpload" onclick="document.getElementById('incarcaImagine').click()">
                                    <i class="fa-solid fa-upload"></i> Upload
                                </button>
                                @if (string.IsNullOrEmpty(Model.Thumbnail) || !Model.Thumbnail.Contains("https://upload.wikimedia.org"))
                                {
                                    <button id="btnAI" type="button" class="tool-btn ai-magic">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Instant Cover
                                    </button>
                                }
                            </div>
                            <div id="salveazaEditare">
                                <button id="anulareEditare" onclick="afiseazaEdit(false)">Cancel</button>
                                <button id="saveBtn" onclick="salveazaEditareBanner()">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

            <div id="carduriStat">
                <div class="cardMic">
                    <div class="cercIcon portocaliu"><i class="fa-solid fa-clock"></i></div>
                    <div class="textStat">
                        <p>Trip Duration</p>
                        <span>@nrZile Days</span>
                    </div>
                </div>
                <div class="cardMic">
                    <div class="cercIcon verde"><i class="fa-solid fa-user-group"></i></div>
                    <div class="textStat">
                        <p>Participants</p>
                        <span>@(Model.ListaParticipanti?.Count ?? 0) Friends</span>
                    </div>
                </div>
                <div class="cardMic">
                    <div class="cercIcon mov"><i class="fa-solid fa-map-location-dot"></i></div>
                    <div class="textStat">
                        <p>Locations</p>
                        <span>@(Model.Locatii?.Count ?? 0) Cities</span>
                    </div>
                </div>
                <div class="cardMic">
                    <div class="cercIcon albastru"><i class="fas fa-comment-alt"></i></div>
                    <div class="textStat">
                        <p></p>
                        <span>Chat</span>
                    </div>
                </div>
                <div class="cardMic">
                    <div class="cercIcon verde"><i class="fa-solid fa-map"></i></i></div>
                    <div class="textStat">
                        <p></p>
                        <span>Itinerary</span>
                    </div>
                </div>
            </div>
            <div id="mainLayout">
                <div id="leftCol">
                    <section id="membersBox">
                        <h5 id="boxTitle">Trip Participants</h5>
                        <div id="membersList">
                            @foreach (var membru in Model.ListaParticipanti)
                            {
                                <div id="memberRow_@membru.ProfilId" class="rand-membru @(membru.Confirmare == "PENDING" ? "status-asteptare" : "")">
                                    <img src="@(string.IsNullOrEmpty(membru.Profil.ImagineProfil) ? "/images/default.png" : membru.Profil.ImagineProfil)"
                                         id="memberAvatar_@membru.ProfilId" class="avatar-membru">

                                    <div id="memberInfo_@membru.ProfilId">
                                        <p id="memberName_@membru.ProfilId" class="nume-membru">@membru.Profil.User.UserName</p>
                                        <p id="memberRole_@membru.ProfilId" class="rol-membru @membru.Confirmare.ToLower()">
                                            @if (membru.Confirmare == "PENDING")
                                            {
                                                <span style="color: teal">Pending</span>
                                            }
                                            else
                                            {
                                                <span>@membru.Confirmare</span>
                                            }
                                        </p>
                                    </div>
                                </div>
                            }
                            </div>
                        <button id="inviteBtn">Invite Friends</button>
                    </section>
                    <section id="calendarGrup">
                        <div id="calendarHeader">
                            <h5 id="titluCalendar">Trip Dates <i class="fa-solid fa-circle-check" id="confirmareData" style="display: none; color: #f1c40f; cursor: pointer;"></i></h5>
                            <div id="controaleLuna">
                                <button id="lunaPrecedenta"><i class="fa-solid fa-chevron-left"></i></button>
                                <span id="numeLunaAn"></span> <button id="lunaUrmatoare"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div id="containerZile"></div>
                    </section>
                    <section id="flightBox">
                        <h5 id="flightTitle">Flight Tickets</h5>
                        <div id="airlineInfo">
                            <div id="airlineLogo">
                                <i class="fa-solid fa-plane-departure"></i>
                            </div>
                            <div id="flightCode">
                                <p id="airlineName">Generic Airline</p>
                                <p id="planeModel">A1 123</p>
                            </div>
                        </div>
                        <div id="flightTimes">
                            <div id="departCol">
                                <span id="departLabel">Departure</span>
                                <p id="departTime">10:00 AM (JFK)</p>
                            </div>
                            <div id="arriveCol">
                                <span id="arriveLabel">Arrival</span>
                                <p id="arriveTime">2:00 PM (JTR)</p>
                            </div>
                        </div>
                        <button id="ticketBtn">View Ticket</button>
                    </section>

                    <section id="hotelBox">
                        <h5 id="hotelTitle">Booking Accommodation</h5>
                        <p id="hotelName">Grace Hotel Santorini</p>
                        <div id="stayDates">
                            <div id="checkIn">
                                <span id="inLabel">Check-in</span>
                                <p id="inDate">@Model.DataPlecare?.ToString("MMMM dd, yyyy")</p>
                            </div>
                            <div id="checkOut">
                                <span id="outLabel">Check-out</span>
                                <p id="outDate">@Model.DataIntoarcere?.ToString("MMMM dd, yyyy")</p>
                            </div>
                        </div>
                        <button id="addressBtn">Address</button>
                    </section>
                </div>

                <div id="rightCol">
                    <section id="stopsBox">
                        <div id="titluSiEditLocatii">
                            <h5 id="stopsTitle">Planned Stops</h5>
                            <i id="btnEditDestinatie" class="fa-solid fa-pen-to-square btn-edit-stops" aria-hidden="true"></i>
                        </div>
                        <div id="stopsList">
                            @foreach (var loc in Model.Locatii)
                            {
                                <div id="stopRow_@loc.Id">
                                    <div id="stopIcon_@loc.Id">
                                        <i class="fa-solid fa-location-dot"></i>
                                    </div>
                                    <div id="stopInfo_@loc.Id">
                                        <p id="stopName_@loc.Id">@loc.Locatie</p>
                                    </div>
                                </div>
                            }
                        </div>
                        <div id="popUpDestinatieManuala" style="display: none;">
                            <div id="continutPopUp">
                                <div id="headerPopUpDestinatieManuala">
                                    <h3><i class="fa-solid fa-map-location-dot"></i> Add Destinations</h3>
                                    <button type="button" id="inchidePopUp" class="close-btn">&times;</button>
                                </div>

                                <div id="popUpBody">
                                    <div id="destinatieSearchManual">
                                        <input type="text" id="mapSearchInput" placeholder="Search for a city...">
                                        <button type="button" id="btnCautaOras"><i class="fa-solid fa-magnifying-glass"></i></button>
                                        <div id="searchSugestii"></div>
                                    </div>

                                    <div class="OraseSelectate">
                                        <p>Selected Cities:</p>
                                        <div id="listaOraseSelectate"></div>
                                    </div>

                                    <div id="mapContainer"></div>
                                </div>

                                <div class="popUpConfirm">
                                    <button type="button" id="btnConfirmaDestinatii">Confirm Destinations</button>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section id="scheduleBox">
                        <h5 id="scheduleTitle">Upcoming Schedule</h5>
                        <div id="scheduleList">
                            @foreach (var loc in Model.Locatii)
                            {
                                <div id="itemRow_@loc.Id">
                                    <div id="dateMarker_@loc.Id">
                                        <span id="monthText_@loc.Id">@Model.DataPlecare?.ToString("MMM")</span>
                                        <span id="dayText_@loc.Id">@(Model.DataPlecare?.Day.ToString() ?? "00")</span>
                                    </div>
                                    <div id="eventDetails_@loc.Id">
                                        <p id="eventTitle_@loc.Id">Arrival & Exploration: @loc.Locatie</p>
                                        <p id="eventDesc_@loc.Id">Check-in at local stay • 02:00 PM</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </section>
                <section id="mapBox">
                    <div id="mapHeader">
                        <h5 id="mapTitle">Trip Map</h5>
                    </div>
                    <div id="mapDisplay" style="height: 300px; position: relative;">
                        <div id="tripMainMap" style="width: 100%; height: 100%; border-radius: 12px;"></div>
                    </div>
                </section>
                    <section id="budgetBox">
                        <div id="budgetHeader">
                            <h5 id="budgetTitle">Budget Progress</h5>
                        </div>

                        <div id="budgetStats">
                            <div id="pooledInfo">
                                <span id="pooledLabel">Total Pooled</span>
                                <h4 id="pooledValue">$18,450</h4>
                            </div>
                            <div id="percentInfo">
                                <span id="percentValue">74% of Goal</span>
                            </div>
                        </div>

                        <div id="progressBar">
                            <div id="progressFill"></div>
                        </div>

                        <div id="budgetFooter">
                            <div id="paidInfo">
                                <span id="paidLabel">PAID</span>
                                <p id="paidValue">6 Members</p>
                            </div>
                            <div id="unpaidInfo">
                                <span id="unpaidLabel">UNPAID</span>
                                <p id="unpaidValue">2 Members</p>
                            </div>
                        </div>
                    </section>
                    <section id="CasetaDoc">
                        <h5 id="TitluDoc">Trip Documents</h5>
                        <div id="ListaDoc">
                            @foreach (var doc in Model.Documente)
                            {
                                <div id="RandDoc-@doc.Id">
                                    <div id="InfoDoc-@doc.Id">
                                        <div id="IconDoc-@doc.Id">
                                            <i id="ImagineIcon-@doc.Id" class="@IconitaFisier(doc.NumeFisier)"></i>
                                        </div>
                                        <p id="NumeDoc-@doc.Id">@doc.NumeFisier</p>
                                    </div>
                                    <i id="StergeDoc-@doc.Id" class="fa-solid fa-xmark" style="cursor: pointer; color: #cbd5e1;" onclick="EliminaDoc(@doc.Id)"></i>
                                </div>
                            }
                        </div>
                        <input type="file" id="InputFisier" style="display:none" onchange="IncarcaDoc(this)">
                        <button id="ButonIncarca" onclick="document.getElementById('InputFisier').click()">Upload New</button>
                    </section>
                </div>
            </div>
        </div>
        <div id="popUpInvitatieTG">
            <div id="editInvitatieTG">
                <div id="headerPopUpDestinatieManuala">
                    <h3><i class="fa-solid fa-user-plus"></i> Invite Friends</h3>
                    <button type="button" id="xMeniuInvitatieTG" class="close-btn" onclick="meniuInvitatieTG(false)">&times;</button>
                </div>
                <div id="popUpBody">
                    <div id="destinatieSearchManual">
                        <input type="text" id="cautaPrietenInput" placeholder="Search by username...">
                        <button type="button" id="btnCautaPrieten" onclick="cautaPrieteni()"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                    <div id="listaRezultatePrieteni">
                    </div>
                </div>
            </div>
        </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const btnConfirm = document.getElementById('confirmareData');
            if (btnConfirm) {
                btnConfirm.addEventListener('click', salveazaPerioadaNoua);
            }
            const strStartOficial = '@Model.DataPlecare?.ToString("yyyy-MM-dd")';
            const strEndOficial = '@Model.DataIntoarcere?.ToString("yyyy-MM-dd")';
            let dataVizualizata = strStartOficial ? new Date(strStartOficial) : new Date();
            if (isNaN(dataVizualizata.getTime()))
                dataVizualizata = new Date();
            function afiseazaLuna() {
                const container = document.getElementById('containerZile');
                const headerLuna = document.getElementById('numeLunaAn');
                if (!container) 
                    return;
                const an = dataVizualizata.getFullYear();
                const luna = dataVizualizata.getMonth();
                const numeLuna = new Date(an, luna).toLocaleString('default', { month: 'long' });
                if (headerLuna) 
                    headerLuna.innerText = `${numeLuna} ${an}`;
                container.innerHTML = "";
                const zileSaptamana = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
                zileSaptamana.forEach(zi => {
                    const divHeader = document.createElement('div');
                    divHeader.classList.add('nume-zi-header');
                    divHeader.innerText = zi;
                    container.appendChild(divHeader);
                });
                const primaZi = new Date(an, luna, 1).getDay();
                const offset = (primaZi === 0) ? 6 : primaZi - 1;
                for (let s = 0; s < offset; s++) {
                    container.appendChild(document.createElement('div'));
                }
                const nrZile = new Date(an, luna + 1, 0).getDate();
                for (let i = 1; i <= nrZile; i++) {
                    const ziElement = document.createElement('div');
                    ziElement.classList.add('zi-calendar');

                    const lunaF = (luna + 1).toString().padStart(2, '0');
                    const ziF = i.toString().padStart(2, '0');
                    const dataISO = `${an}-${lunaF}-${ziF}`;

                    ziElement.setAttribute('data-date', dataISO);
                    ziElement.innerText = i;
                    if (strStartOficial && strEndOficial) {
                if (dataISO >= strStartOficial && dataISO <= strEndOficial) {
                    ziElement.classList.add('perioada-oficiala');
                }
            }
                ziElement.onclick = function() { gestioneazaClickData(dataISO); };
                container.appendChild(ziElement);
            }
            actualizeazaCuloriZile();
        }
            document.getElementById('lunaPrecedenta').addEventListener('click', (e) => {
                e.preventDefault();
                dataVizualizata.setMonth(dataVizualizata.getMonth() - 1);
                afiseazaLuna();
            });

            document.getElementById('lunaUrmatoare').addEventListener('click', (e) => {
                e.preventDefault();
                dataVizualizata.setMonth(dataVizualizata.getMonth() + 1);
                afiseazaLuna();
            });
            afiseazaLuna();
        });
        let rangeSelectat = [];
        function gestioneazaClickData(data) {
            const bifaConfirmare = document.getElementById('confirmareData');

            if (rangeSelectat.includes(data)) {
                rangeSelectat = rangeSelectat.filter(d => d !== data);
            } else {
                if (rangeSelectat.length >= 2) {
                    rangeSelectat = [data];
                } else {
                    rangeSelectat.push(data);
                }
            }
            rangeSelectat.sort();
            actualizeazaCuloriZile();
            if (bifaConfirmare) {
                bifaConfirmare.style.display = (rangeSelectat.length === 2) ? 'inline-block' : 'none';
            }
        }

        function actualizeazaCuloriZile() {
            const toateZilele = document.querySelectorAll('.zi-calendar');

            toateZilele.forEach(zi => {
                const d = zi.getAttribute('data-date');
                zi.classList.remove('zi-selectata');

                if (rangeSelectat.length === 1) {
                    if (d === rangeSelectat[0])
                        zi.classList.add('zi-selectata');
                } else if (rangeSelectat.length === 2) {
                    if (d >= rangeSelectat[0] && d <= rangeSelectat[1]) {
                        zi.classList.add('zi-selectata');
                    }
                }
            });
        }
        async function salveazaPerioadaNoua() {
            if (rangeSelectat.length !== 2) {
                return;
            }
            const banner = document.getElementById('bannerVizualizare');
            if (!banner) {
                return;
            }
            const idGrup = banner.getAttribute('data-idGrup');
            const formData = new FormData();
            formData.append("id", idGrup);
            formData.append("dataPlecare", rangeSelectat[0]); 
            formData.append("dataIntoarcere", rangeSelectat[1]); 
            try {
                const res = await fetch('/TravelGroup/ActualizarePerioada', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    location.reload();
                }
            } catch (err) {
                console.error("Error:", err);
            }
        }
    </script>

    </body>
    @section Scripts {
        <script src="~/js/vizualizareTG.js"></script>
        <script src="~/js/butonSideMenu.js" asp-append-version="true"></script>
        <script src="~/js/inviteTG.js" asp-append-version="true"></script>
    }
</html>
